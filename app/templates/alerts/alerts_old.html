{% extends "_design.html" %}
{% block content %}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Alerts</h3>
        <div>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">Filters</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkModal">Bulk Actions</button>
            <a href="/web/v1/alerts?{{ request.query_params }}" class="btn btn-outline-primary">Refresh</a>
        </div>
    </div>

    <div class="mb-3 d-flex align-items-center">
        <div class="form-check me-3">
            <input class="form-check-input" type="checkbox" id="select-all-visible">
            <label class="form-check-label" for="select-all-visible">Select All</label>
        </div>
        <small class="text-muted" id="selected-count">0 alerts selected</small>
    </div>

    <div class="mb-3 d-flex justify-content-between align-items-center">
        <small class="text-muted">{{ pagination.total_results }} results found</small>
        <div>
            <label for="limitSelect" class="form-label me-2">Alerts per page:</label>
            <select id="limitSelect" class="form-select d-inline-block w-auto">
                {% for option in [10, 20, 50, 100, 200, 500, 1000] %}
                <option value="{{ option }}" {% if limit == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <nav>
        <ul class="pagination">
            {% if pagination.show_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.prev_page }}&{{ pagination.query_string }}">Previous</a>
            </li>
            {% endif %}

            {% for p in range(1, pagination.total_pages + 1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&{{ pagination.query_string }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if pagination.show_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.next_page }}&{{ pagination.query_string }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>

    <div id="alerts-cards">
        {% for alert in alerts %}
        <div class="card alert-card shadow-sm border mb-3">
            <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
                <div class="form-check me-3">
                    <input class="form-check-input alert-checkbox" type="checkbox" value="{{ alert.id }}">
                </div>
                <div class="flex-fill me-3">
                    <h5 class="mb-1">{{ alert.message }}</h5>
                    <small class="text-muted">ID: {{ alert.id }} | Created: {{ alert.created_at_formatted }}</small>
                </div>
                {% for field in alert.display_fields %}
                <div class="me-3">
                    <strong>{{ field.label }}:</strong>
                    {% if field.color %}
                        <span class="badge" style="background-color: {{ field.color }}; color: white;">{{ field.value }}</span>
                    {% elif field.style == 'badge' %}
                        <span class="badge bg-secondary">{{ field.value }}</span>
                    {% elif field.style == 'italic' %}
                        <em>{{ field.value }}</em>
                    {% elif field.style == 'bold' %}
                        <strong>{{ field.value }}</strong>
                    {% elif field.style == 'tag_list' %}
                        {% for tag in field.value.split(',') %}
                        <span class="badge bg-light text-dark me-1">{{ tag.strip() }}</span>
                        {% endfor %}
                    {% else %}
                        {{ field.value }}
                    {% endif %}
                </div>
                {% endfor %}
                <div>
                    <a href="/web/v1/alerts/{{ alert.id }}" class="btn btn-sm btn-outline-primary">View</a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-muted">No alerts found.</div>
        {% endfor %}
    </div>

    <nav>
        <ul class="pagination">
            {% if pagination.show_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.prev_page }}&{{ pagination.query_string }}">Previous</a>
            </li>
            {% endif %}

            {% for p in range(1, pagination.total_pages + 1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&{{ pagination.query_string }}">{{ p }}</a>
            </li>
            {% endfor %}

            {% if pagination.show_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.next_page }}&{{ pagination.query_string }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>

{% include "alerts/_bulk_modal.html" %}
{% include "alerts/_filter_modal.html" %}

<script>
    document.querySelector("#filterModal form").addEventListener("submit", function (e) {
        const form = e.target;
        const params = new URLSearchParams(new FormData(form));
        console.log("Submitting filter URL:", `/web/v1/alerts?${params.toString()}`);
    });

    document.getElementById("limitSelect").addEventListener("change", function () {
        const params = new URLSearchParams(window.location.search);
        params.set('limit', this.value);
        params.set('page', '1');
        window.location.search = params.toString();
    });

    function updateSelectionUI() {
        const checkboxes = document.querySelectorAll(".alert-checkbox");
        let selectedCount = 0;
        checkboxes.forEach(cb => {
            const card = cb.closest(".alert-card");
            if (cb.checked) {
                selectedCount++;
                card.classList.add("border-warning", "bg-light");
            } else {
                card.classList.remove("border-warning", "bg-light");
            }
        });
        document.getElementById("selected-count").textContent = `${selectedCount} alert${selectedCount === 1 ? '' : 's'} selected`;
    }

    document.querySelectorAll(".alert-checkbox").forEach(cb => cb.addEventListener("change", updateSelectionUI));

    document.getElementById("select-all-visible").addEventListener("change", function () {
        const checked = this.checked;
        document.querySelectorAll(".alert-checkbox").forEach(cb => {
            cb.checked = checked;
        });
        updateSelectionUI();
    });

    document.getElementById("bulkActionForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const selectedIds = Array.from(document.querySelectorAll(".alert-checkbox:checked")).map(cb => cb.value);
        if (selectedIds.length === 0) {
            alert("No alerts selected.");
            return;
        }
        document.getElementById("selectedAlertIds").value = selectedIds.join(",");
        this.submit();
    });

    document.getElementById("clearFiltersBtn").addEventListener("click", function () {
        window.location.href = '/web/v1/alerts';
    });
</script>

{% endblock %}
