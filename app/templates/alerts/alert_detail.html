{% extends "_design.html" %}
{% block title %}Alert #{{ alert.id }} - Sentinel Commander{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">üö® Alert #{{ alert.id }} - {{ alert.message }}</h3>
        <a href="/web/v1/alerts" class="btn btn-outline-secondary">&larr; Back</a>
      </div>

      <!-- Search and Controls -->
      <div class="d-flex flex-wrap gap-2 mb-4">
        <div class="input-group flex-fill" style="max-width: 75%;">
          <input type="text" id="alertSearch" class="form-control" placeholder="üîç Search alert content...">
          <button class="btn btn-outline-primary" id="alertSearchButton" type="button">Search</button>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">Expand All</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">Collapse All</button>
        </div>
      </div>

      <!-- Search Results Modal -->
      <div class="modal fade" id="searchResultModal" tabindex="-1" aria-labelledby="searchResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content" style="background-color: var(--sc-card-bg); color: var(--sc-text);">
            <div class="modal-header">
              <h5 class="modal-title" id="searchResultModalLabel">üîé Search Results</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="searchResultsContent"></div>
          </div>
        </div>
      </div>

      <!-- Accordion Section -->
      <div class="accordion" id="alertAccordion">
        {% for section in rendered_sections %}
        <div class="accordion-item rounded mb-3 border shadow-sm" style="background-color: var(--sc-card-bg); color: var(--sc-text);">
          <h2 class="accordion-header" id="heading-{{ loop.index }}">
            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-{{ loop.index }}"
                    aria-expanded="{{ 'true' if loop.first else 'false' }}">
              <i class="bi bi-folder-fill me-2"></i> {{ section.title }}
            </button>
          </h2>
          <div id="collapse-{{ loop.index }}"
               class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
               data-bs-parent="#alertAccordion">
            <div class="accordion-body">
              <div class="row g-3">
                {% for field in section.fields %}
                <div class="{% if field.style == 'json' %}col-12{% else %}col-md-6{% endif %}">
                  <div class="p-3 rounded border h-100" style="background-color: var(--sc-subtle-bg); color: var(--sc-text);">
                    {% if not field.no_label %}<small class="text-muted d-block mb-1">{{ field.label }}</small>{% endif %}
                    {% if field.style in ['badge', 'severity_color'] %}
                    <span class="badge px-3 py-2 text-white" style="background-color: {{ field.color if field.color else 'var(--sc-muted)' }};">
                      {{ field.value }}
                    </span>
                    {% elif field.style == 'italic' %}
                    <em>{{ field.value }}</em>
                    {% elif field.style == 'bold' %}
                    <strong>{{ field.value }}</strong>
                    {% elif field.style == 'tag_list' %}
                    <div class="d-flex flex-wrap gap-2">
                      {% for tag in field.value.split(',') %}
                      <span class="badge" style="background-color: purple; color: white;">{{ tag.strip() }}</span>
                      {% endfor %}
                    </div>
                    {% elif field.style == 'json' %}
                    <pre class="p-2 border rounded copyable-json" style="background-color: var(--sc-pre-bg); color: var(--sc-pre-text); white-space: pre-wrap; cursor: pointer;"><code>{{ field.value }}</code></pre>
                    {% else %}
                    <code class="copyable-json" style="cursor: pointer; color: var(--sc-text);">{{ field.value }}</code>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Sidebar - Actions -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3" style="background-color: var(--sc-card-bg);">
        <div class="card-header fw-bold" style="background-color: var(--sc-dark); color: white;">
          Actions
        </div>
        <div class="card-body d-grid gap-2" style="color: var(--sc-text);">
          <button class="btn btn-outline-info">‚öôÔ∏è Run Playbooks</button>
          <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editAlertModal">‚úèÔ∏è Edit Alert</button>
          <button class="btn btn-outline-primary">‚ú´Ô∏è Promote to Case</button>
        </div>
      </div>

      {% if alert.resolution_comment or alert.status or alert.resolution %}
      <div class="card shadow-sm" style="background-color: var(--sc-subtle-bg); color: var(--sc-text);">
        <div class="card-header fw-semibold">üìù Alert Summary (Comment) </div>
        <div class="card-body">
          {% if alert.resolution_comment %}<p class="small"><strong>Comment:</strong><br>{{ alert.resolution_comment }}</p>{% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Edit Alert Modal -->
<div class="modal fade" id="editAlertModal" tabindex="-1" aria-labelledby="editAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="/web/v1/alerts/{{ alert.id }}/update">
      <div class="modal-header">
        <h5 class="modal-title" id="editAlertModalLabel">‚úèÔ∏è Edit Alert</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" name="status" id="status">
            <option value="">-- No Change --</option>
            <option value="new">New</option>
            <option value="in_progress">In Progress</option>
            <option value="done">Done</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="resolution" class="form-label">Resolution</label>
          <select class="form-select" name="resolution" id="resolution">
            <option value="">-- No Change --</option>
            <option value="under_investigation">Under Investigation</option>
            <option value="false_positive">False Positive</option>
            <option value="true_positive_no_impact">TP (No Impact)</option>
            <option value="true_positive_with_impact">TP (Impact)</option>
            <option value="not_applicable">Not Applicable</option>
            <option value="legitimate">Legitimate</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="resolution_comment" class="form-label">Resolution Comment</label>
          <textarea class="form-control" name="resolution_comment" id="resolution_comment" rows="3">{{ alert.resolution_comment or '' }}</textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
  <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Copied to clipboard!
      </div>
    </div>
  </div>
</div>

<script>
  function expandAll() {
    document.querySelectorAll('.accordion-collapse').forEach(el => el.classList.add('show'));
  }
  function collapseAll() {
    document.querySelectorAll('.accordion-collapse').forEach(el => el.classList.remove('show'));
  }
  function highlightMatch(text, term) {
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }
  function runSearch() {
    const input = document.getElementById("alertSearch");
    const filter = input.value.toLowerCase().trim();
    if (filter.length < 2) return;
    const results = [];
    const sections = document.querySelectorAll(".accordion-item");
    sections.forEach(section => {
      const title = section.querySelector(".accordion-button")?.innerText.trim();
      const contentElement = section.querySelector(".accordion-body");
      if (!title || !contentElement) return;
      const content = contentElement.innerText.trim();
      if (content.toLowerCase().includes(filter)) {
        section.querySelector(".accordion-collapse")?.classList.add("show");
        results.push(`
          <div class="mb-3">
            <h6>${title}</h6>
            <pre class="p-2 rounded border" style="background-color: var(--sc-pre-bg);">
<code>${highlightMatch(content, filter)}</code></pre>
          </div>
        `);
      }
    });
    const resultsContainer = document.getElementById("searchResultsContent");
    resultsContainer.innerHTML = results.length > 0 ? results.join("") : "<p style='color: var(--sc-muted);'>No matches found.</p>";
    const modal = new bootstrap.Modal(document.getElementById("searchResultModal"));
    modal.show();
  }
  document.getElementById("alertSearchButton").addEventListener("click", runSearch);
  document.getElementById("alertSearch").addEventListener("keypress", function (e) {
    if (e.key === "Enter") runSearch();
  });

  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("copyable-json")) {
      const text = e.target.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const toast = new bootstrap.Toast(document.getElementById('copyToast'));
        toast.show();
      });
    }
  });
</script>
{% endblock %}
