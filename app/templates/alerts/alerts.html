{% extends "_design.html" %}
{% block content %}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Alerts</h3>
        <div>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal"
                    aria-label="Open filters">Filters
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkModal">Bulk Actions</button>
            <a href="/web/v1/alerts?{{ request.query_params }}" class="btn btn-outline-primary">Refresh</a>
        </div>
    </div>

    <div class="mb-3 d-flex align-items-center">
        <div class="form-check me-3">
            <input class="form-check-input" type="checkbox" id="select-all-visible">
            <label class="form-check-label" for="select-all-visible">Select All</label>
        </div>
        <small class="text-muted" id="selected-count">0 alerts selected</small>
    </div>

    <div class="mb-3 d-flex justify-content-between align-items-center">
        <small class="text-muted">{{ pagination.total_results }} results found</small>
        <div>
            <label for="limitSelect" class="form-label me-2">Alerts per page:</label>
            <select id="limitSelect" class="form-select d-inline-block w-auto">
                {% for option in [10, 20, 50, 100, 200, 500, 1000] %}
                <option value="{{ option }}" {% if limit== option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if request.query_params %}
    <div class="alert alert-light border d-flex align-items-center justify-content-between mb-3 shadow-sm"
         style="background-color: var(--sc-card-bg); color: var(--sc-text); border-color: var(--sc-border);">
        <div>
            <strong>Active Filters:</strong>
            {% if request.query_params.get('alert_id') %}<span class="badge badge-secondary me-1" title="Alert ID">ID: {{ request.query_params.get('alert_id') }}</span>{%
            endif %}
            {% if request.query_params.get('status') %}<span class="badge badge-primary me-1" title="Status">Status: {{ request.query_params.get('status') }}</span>{%
            endif %}
            {% if request.query_params.get('severity') %}<span class="badge badge-danger me-1" title="Severity">Severity: {{ request.query_params.get('severity') }}</span>{%
            endif %}
            {% if request.query_params.get('tags') %}<span class="badge badge-info text-dark me-1" title="Tags">Tags: {{ request.query_params.get('tags') }}</span>{%
            endif %}
            {% if request.query_params.get('search') %}<span class="badge badge-dark me-1" title="Search">Search: {{ request.query_params.get('search') }}</span>{%
            endif %}
        </div>
        <div>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">Edit
                Filters
            </button>
            <a href="/web/v1/alerts" class="btn btn-sm btn-outline-danger">Clear</a>
        </div>
    </div>
    {% endif %}

    <div id="alerts-cards">
        {% for alert in alerts %}
        <div class="card alert-card shadow-sm border mb-3" id="card-{{ alert.id }}">
            <div class="card-body alert-body d-flex flex-wrap align-items-center justify-content-between"
                 onclick="toggleCollapse('{{ alert.id }}')">
                <div class="form-check me-3">
                    <input class="form-check-input alert-checkbox" type="checkbox" value="{{ alert.id }}"
                           onclick="event.stopPropagation();">
                </div>

                <div class="flex-fill me-3">
                    <h5 class="mb-1">{{ alert.parsed_fields.title if alert.parsed_fields and alert.parsed_fields.title
                        else alert.message }}</h5>
                    <small class="text-muted">ID: {{ alert.id }} | Created: {{ alert.created_at_formatted }}</small>
                </div>

                <div class="me-3">
                    <label>Status:</label>
                    <span class="status-badge status-{{ alert.status|lower|replace('_', '-') }}" title="Status: {{ alert.status }}">{{ alert.status.replace('_', ' ')|title }}</span>
                </div>

                {% if alert.severity_label %}
                <div class="me-3">
                    <label>Severity:</label>
                    <span class="severity-badge severity-{{ alert.severity_label|lower }}"
                          title="Severity: {{ alert.severity_label }}">{{ alert.severity_label }}</span>
                </div>
                {% endif %}

                <div class="toggle-icon">
                    <i class="bi bi-chevron-down" id="toggle-icon-{{ alert.id }}"></i>
                </div>
            </div>

            <div class="collapse px-4 pb-3" id="alert-{{ alert.id }}">
                <hr>
                <div class="row">
                    <div class="col-md-4"><strong>Resolution:</strong> {{ alert.resolution.replace('_', ' ')|title if
                        alert.resolution else '—' }}
                    </div>
                    <div class="col-md-4"><strong>Source:</strong> {{ alert.source or '—' }}</div>
                </div>
                <div class="mt-2"><strong>Resolution Comment:</strong> {{ alert.resolution_comment or '—' }}</div>
                <div class="mt-2"><strong>Tags:</strong>
                    {% if alert.tags %}
                    {% for tag in alert.tags.split(',') %}
                    <span class="badge bg-light text-dark me-1">{{ tag.strip() }}</span>
                    {% endfor %}
                    {% else %}—{% endif %}
                </div>
                <div class="mt-3 d-flex gap-2">
                    <a href="/web/v1/alerts/{{ alert.id }}" class="btn btn-sm btn-outline-primary">View Full Alert</a>
                    <button class="btn btn-sm btn-outline-primary"
                            onclick="openEditModal('{{ alert.id }}'); event.stopPropagation();">Edit
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if alerts %}
    <nav>
        <ul class="pagination">
            {% if pagination.show_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.prev_page }}&{{ pagination.query_string }}">Previous</a>
            </li>
            {% endif %}
            {% for p in range(1, pagination.total_pages + 1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&{{ pagination.query_string }}">{{ p }}</a>
            </li>
            {% endfor %}
            {% if pagination.show_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ pagination.next_page }}&{{ pagination.query_string }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

{% include "alerts/_bulk_modal.html" %}
{% include "alerts/_filter_modal.html" %}

<script>
    /**
     * Submit filter form and log the constructed filter URL.
     */
    document.querySelector("#filterModal form").addEventListener("submit", function (e) {
        const form = e.target;
        const params = new URLSearchParams(new FormData(form));
        console.log("Submitting filter URL:", `/web/v1/alerts?${params.toString()}`);
    });

    /**
     * Handle "alerts per page" selection changes.
     * Resets page to 1 and updates the query params.
     */
    document.getElementById("limitSelect").addEventListener("change", function () {
        const params = new URLSearchParams(window.location.search);
        params.set('limit', this.value);
        params.set('page', '1');
        window.location.search = params.toString();
    });

    /**
     * Update UI when alerts are selected or deselected.
     * Highlights selected cards and updates the selected count.
     */
    function updateSelectionUI() {
        const checkboxes = document.querySelectorAll(".alert-checkbox");
        let selectedCount = 0;

        checkboxes.forEach(cb => {
            const card = cb.closest(".alert-card");
            if (cb.checked) {
                selectedCount++;
                card.classList.add("border-warning", "selected-alert");
            } else {
                card.classList.remove("border-warning", "selected-alert", "bg-light"); // Remove any selection styles
            }
        });

        document.getElementById("selected-count").textContent = `${selectedCount} alert${selectedCount === 1 ? '' : 's'} selected`;
    }

    /**
     * Bind individual checkbox selection handlers.
     */
    document.querySelectorAll(".alert-checkbox").forEach(cb =>
        cb.addEventListener("change", updateSelectionUI)
    );

    /**
     * Handle "Select All" checkbox functionality.
     * Selects/deselects all visible alert checkboxes.
     */
    document.getElementById("select-all-visible").addEventListener("change", function () {
        const checked = this.checked;
        document.querySelectorAll(".alert-checkbox").forEach(cb => {
            cb.checked = checked;
        });
        updateSelectionUI();
    });

    /**
     * Handle bulk action form submission.
     * Validates selection and sets hidden input with alert IDs.
     */
    document.getElementById("bulkActionForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const selectedIds = Array.from(
            document.querySelectorAll(".alert-checkbox:checked")
        ).map(cb => cb.value);

        if (selectedIds.length === 0) {
            alert("No alerts selected.");
            return;
        }

        document.getElementById("selectedAlertIds").value = selectedIds.join(",");
        this.submit(); // Proceed with form submission
    });

    /**
     * Clears filters by redirecting to the base alerts URL.
     */
    document.getElementById("clearFiltersBtn").addEventListener("click", function () {
        window.location.href = '/web/v1/alerts';
    });

    /**
     * Setup toggle arrow icon behavior for alert collapse elements.
     */
    document.querySelectorAll('.alert-card').forEach(card => {
        const collapse = card.querySelector('.collapse');
        const icon = card.querySelector('.toggle-icon i');

        collapse.addEventListener('show.bs.collapse', () => {
            icon.classList.remove('bi-chevron-down');
            icon.classList.add('bi-chevron-up');
        });

        collapse.addEventListener('hide.bs.collapse', () => {
            icon.classList.remove('bi-chevron-up');
            icon.classList.add('bi-chevron-down');
        });
    });

    /**
     * Open edit modal for a single alert.
     * Automatically checks the alert and updates modal content.
     */
    function openEditModal(alertId) {
        document.querySelectorAll(".alert-checkbox").forEach(cb => {
            cb.checked = cb.value === alertId;
        });

        document.getElementById("selectedAlertIds").value = alertId;
        document.getElementById("selected-count").textContent = `1 alert selected`;

        const bulkModal = new bootstrap.Modal(document.getElementById('bulkModal'));
        bulkModal.show();
    }

    function smoothScrollToCard(cardElement) {
        setTimeout(() => {
            cardElement.scrollIntoView({behavior: 'smooth', block: 'start'});
        }, 10); // A small delay ensures transition timing
    }

    /**
     * Collapse/expand an alert card and scroll it into view when expanded.
     */
    function toggleCollapse(alertId) {
        const collapseElement = document.getElementById(`alert-${alertId}`);
        const cardElement = document.getElementById(`card-${alertId}`);
        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);

        // Toggle collapse
        bsCollapse.toggle();
    }

</script>


{% endblock %}
